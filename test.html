<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://fontawesome.com/icons/gear?f=classic&s=solid">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <title>Pollenapp</title>
    <style>
        /* _________________HEADER____________________ */
        .header-menu {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            /* height: 110px; */
            background-color: #4BA598;
            padding: 2rem 0;
        }

        /* _________________MAIN_CONTAINER____________________ */
        .container {
            background-color: #F2F2F2;
            padding: 6rem 0;
            height: calc(100vh - 200px); /* Adjusted the height of the map container */
            overflow: hidden; /* Prevent scrolling */
        }

        #location {
            display: flex;
            justify-content: center;
            color: white;
            font-size: 32px;
        }

        #PollenData ul li {
            list-style: none;
        }

        /* _________________MAP____________________ */
        #map {
            height: 100%;
            width: 100%;
        }

        /* _________________TOGGLE SWITCH____________________ */
        .toggle-container {
            display: block;
            justify-content: space-around;
            grid-row: auto;
            margin-top: 20px;
            margin-right: 10px;
        }

        .toggle-container label {
            display: block;
            margin-right: 30px;
            font-size: 16px;
        }

        .toggle-container input[type="checkbox"] {
            display: none;
        }

        .toggle-slider {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
            border-radius: 20px;
            background-color: #ccc;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            border-radius: 50%;
            background-color: white;
            transition: 0.4s;
        }

        input[type="checkbox"]:checked + .toggle-slider {
            background-color: #4BA598;
        }

        input[type="checkbox"]:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        /* _________________FOOTER____________________ */
        .footer-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 90px;
            background-color: #4BA598;
            display: flex;
            justify-content: space-between;
        }

        .footer-menu button {
            padding: 0.5rem 1rem;
            margin: 0.5rem 2rem;
            background-color: #4BA598;
            color: #F2F2F2;
            border: none;
        }

        .footer-menu button i{
            font-size: 30px;
        }
    </style>
</head>

<body>
    <header class="header-menu">
        <section id="location"></section>
    </header>
    <div class="container">
        <section id="PollenData"></section>
        <!-- Map container with height defined -->
        <div id="map"></div>
    </div>
    <footer class="footer-menu">
        <button id="myHome"><i class="fa fa-home"></i></button>
        <button id="myMap"><i class="fa fa-map-o"></i></button>
        <button id="mySetting"><i class="fa fa-cog"></i></button>
    </footer>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const myMapButton = document.getElementById('myMap');
            myMapButton.addEventListener('click', function() {
                clearContainer();
                buildMap();
            });
            const mySettingButton = document.getElementById('mySetting');
            mySettingButton.addEventListener('click', showToggleSwitches);
            const myHomeButton = document.getElementById('myHome');
            myHomeButton.addEventListener('click', resetPage);

            // Call getLocation when the page loads
            getLocation();
        });

        function clearContainer() {
            const container = document.querySelector('.container');
            container.innerHTML = ''; // Clearing all child elements
        }

        function resetPage() {
            location.reload(); // Reloads the page
        }

        function buildMap() {
            const container = document.querySelector('.container');
            container.innerHTML = '<div id="map"></div>';

            const map = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            map.locate({ setView: true, maxZoom: 16 });

            function onLocationFound(e) {
                const radius = e.accuracy / 2;
                L.marker(e.latlng).addTo(map)
                    .bindPopup(`You are within ${radius} meters from this point`).openPopup();
                L.circle(e.latlng, radius).addTo(map);
            }

            function onLocationError(e) {
                alert(e.message);
            }

            map.on('locationfound', onLocationFound);
            map.on('locationerror', onLocationError);
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    fetchLocationAndData(lat, lon);
                }, error => {
                    console.error('Error getting location:', error.message);
                });
            } else {
                alert("Geolocation is not supported by this browser.")
            }
        }

        function fetchLocationAndData(lat, lon) {
            fetch(`https://geocode.maps.co/reverse?lat=${lat}&lon=${lon}&api_key=65fb5ea644244903025253axe09afbb`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Location API request failed');
                    }
                    return response.json();
                })
                .then(data => {
                    const city = data.address.city;
                    document.getElementById("location").innerText = city;
                })
                .catch(error => {
                    console.error('Error fetching location:', error.message);
                });

            const timeZone = "Europe%2FBerlin";
            fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=alder_pollen,birch_pollen,grass_pollen,mugwort_pollen,olive_pollen,ragweed_pollen&hourly=alder_pollen,birch_pollen,grass_pollen,mugwort_pollen,olive_pollen,ragweed_pollen&timezone=${timeZone}&forecast_days=1`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Pollution API request failed');
                    }
                    return response.json();
                })
                .then(data => {
                    displayPollenData(data);
                })
                .catch(error => {
                    console.error('Error fetching pollution data:', error.message);
                });
        }

        function displayPollenData(data) {
            const currentData = data.current;
            const pollenDataHtml = `
                <section id="currentValues">
                    <h2>Pollental</h2>
                    <ul>
                        <li>El ${currentData.alder_pollen} p/m³</li>
                        <li>Birk ${currentData.birch_pollen} p/m³</li>
                        <li>Græs ${currentData.grass_pollen} p/m³</li>
                        <li>Bynke ${currentData.mugwort_pollen} p/m³</li>
                        <li>Oliven ${currentData.olive_pollen} p/m³</li>
                        <li>Ambrosia ${currentData.ragweed_pollen} p/m³</li>
                    </ul>
                </section>`;
            document.getElementById('PollenData').innerHTML = pollenDataHtml;
        }

        function showToggleSwitches() {
            const container = document.querySelector('.container');
            container.innerHTML = ''; // Clear previous content

            const toggleContainer = document.createElement('div');
            toggleContainer.classList.add('toggle-container');

            const toggleNames = [
                'El',
                'Birk',
                'Græs',
                'Bynke',
                'Oliven',
                'Ambrosia'
            ];

            toggleNames.forEach(name => {
                const label = document.createElement('label');
                label.textContent = name;

                const toggleInput = document.createElement('input');
                toggleInput.type = 'checkbox';
                toggleInput.classList.add('toggle-input');
                toggleInput.addEventListener('change', toggleSwitchChanged);

                const toggleSlider = document.createElement('span');
                toggleSlider.classList.add('toggle-slider');

                label.appendChild(toggleInput);
                label.appendChild(toggleSlider);

                toggleContainer.appendChild(label);
            });

            container.appendChild(toggleContainer);
        }

        function toggleSwitchChanged(event) {
            const isChecked = event.target.checked;
            // Do something when the toggle switch is changed
            console.log('Toggle switch changed:', isChecked);
        }
    </script>
</body>

</html>
